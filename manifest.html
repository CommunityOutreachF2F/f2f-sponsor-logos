<script>
(async function () {
  const grid = document.getElementById('grid');
  const empty = document.getElementById('empty');
  const q = document.getElementById('q');
  const tier = document.getElementById('tier');
  const eventSel = document.getElementById('event');
  const copyCsvBtn = document.getElementById('copyCsv');
  const reloadBtn = document.getElementById('reload');

  async function loadManifest() {
    // Force a fresh fetch every time (defeat browser caching)
    const cacheBust = '?ts=' + Date.now();
    const url = './logos/manifest.json' + cacheBust;
    console.log('Fetching manifest from:', url);

    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error('manifest.json not found');

    const data = await res.json();
    const count = Array.isArray(data.logos) ? data.logos.length : 0;
    console.log('Loaded', count, 'logo rows.');
    return data;
  }

  function uniq(arr) {
    return [...new Set(arr.filter(Boolean))].sort();
  }

  function render(data) {
    const qv = q.value.trim().toLowerCase();
    const tv = tier.value;
    const ev = eventSel.value;

    const rows = (data.logos || []).filter(r => {
      const hay = [r.company, r.event, r.tier, r.variant, r.format, r.filename]
        .join(' ')
        .toLowerCase();
      if (qv && !hay.includes(qv)) return false;
      if (tv && r.tier !== tv) return false;
      if (ev && r.event !== ev) return false;
      return true;
    });

    grid.innerHTML = '';
    empty.hidden = rows.length !== 0;

    rows.forEach(r => {
      const card = document.createElement('article');
      card.className = 'card';
      const imgURL = r.url || (data.meta?.base_url ? data.meta.base_url + (r.path || r.filename) : r.filename);

      card.innerHTML = `
        <div class="logo-wrap">
          <img src="${imgURL}" alt="${r.company}">
        </div>
        <div class="row">
          <span class="pill">${r.tier || 'Tier n/a'}</span>
          <span class="pill">${r.variant || 'variant'}</span>
          <span class="pill">${(r.format || '').toUpperCase()}</span>
        </div>
        <div class="meta">
          <strong>${r.company}</strong><br>
          ${r.event || ''}${r.event ? ' • ' : ''}${r.filename}
        </div>
        <div class="row">
          <button class="btn" data-copy="${imgURL}">Copy URL</button>
          <a class="btn secondary" href="${imgURL}" target="_blank" rel="noopener">Open</a>
        </div>
      `;
      grid.appendChild(card);
    });

    // Copy buttons
    grid.querySelectorAll('button[data-copy]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const val = btn.getAttribute('data-copy');
        try {
          await navigator.clipboard.writeText(val);
          btn.textContent = 'Copied!';
          setTimeout(() => (btn.textContent = 'Copy URL'), 1200);
        } catch {
          prompt('Copy URL:', val);
        }
      });
    });

    // Tiny feedback message for you in the console
    console.log('Render complete. If you see no cards, check that logos/manifest.json has a "logos" array.');
  }

  try {
    const data = await loadManifest();

    // Populate filters
    uniq(data.logos.map(r => r.tier)).forEach(v => {
      const o = document.createElement('option'); o.value = v; o.textContent = v; tier.appendChild(o);
    });
    uniq(data.logos.map(r => r.event)).forEach(v => {
      const o = document.createElement('option'); o.value = v; o.textContent = v; eventSel.appendChild(o);
    });

    // Wire up controls
    const refresh = () => render(data);
    q.addEventListener('input', refresh);
    tier.addEventListener('change', refresh);
    eventSel.addEventListener('change', refresh);
    reloadBtn.addEventListener('click', async () => {
      try {
        const fresh = await loadManifest();
        render(fresh);
      } catch (e) {
        alert('Reload failed: ' + e.message);
      }
    });

    // Initial render
    render(data);
  } catch (e) {
    grid.innerHTML = '';
    empty.hidden = false;
    empty.textContent = 'Could not load logos/manifest.json — add the file, then refresh.';
    console.error(e);
  }
})();
</script>
